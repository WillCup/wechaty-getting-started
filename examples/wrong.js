/**
 * Wechaty - WeChat Bot SDK for Personal Account, Powered by TypeScript, Docker, and üíñ
 *  - https://github.com/chatie/wechaty
 */
const {
  FileBox,
  UrlLink ,
  Wechaty,
  ScanStatus,
  log,
}               = require('wechaty')

const axios = require('axios')
const fs = require('fs')
const randomInt = require('random-int')

const request = require('request')

const CGT = fs.readFileSync('./examples/ËèúÊ†πË∞≠.txt', 'utf-8').split('\r\n')

const ZGXW = fs.readFileSync('./examples/Â¢ûÂπøË¥§Êñá.txt', 'utf-8').split('\r\n')
const DJT_CONTENT = fs.readFileSync('./examples/ÊØíÈ∏°Ê±§.txt', 'utf-8').split('\n')

/**
 * You can ignore the next line becasue it is using for CodeSandbox
 */
require('./.util/helper')

const ddict = [
  "Âù§‰∏∫Âú∞000000=0",
  "Â±±Âú∞Ââ•000001=1",
  "Ê∞¥Âú∞ÊØî000010=2",
  "È£éÂú∞ËßÇ000011=3",
  "Èõ∑Âú∞Ë±´000100=4",
  "ÁÅ´Âú∞Êôã000101=5",
  "Ê≥ΩÂú∞ËêÉ000110=6",
  "Â§©Âú∞Âê¶000111=7",
  "Âú∞Â±±Ë∞¶001000=8",
  "ËâÆ‰∏∫Â±±001001=9",
  "Ê∞¥Â±±Ëπá001010=10",
  "È£éÂ±±Ê∏ê001011=11",
  "Èõ∑Â±±Â∞èËøá001100=12",
  "ÁÅ´Â±±ÊóÖ001101=13",
  "Ê≥ΩÂ±±Âí∏001110=14",
  "Â§©Â±±ÈÅØ001111=15",
  "Âú∞Ê∞¥Â∏à010000=16",
  "Â±±Ê∞¥Ëíô010001=17",
  "Âùé‰∏∫Ê∞¥010010=18",
  "È£éÊ∞¥Ê∂£010011=19",
  "Èõ∑Ê∞¥Ëß£010100=20",
  "ÁÅ´Ê∞¥Êú™Êµé010101=21",
  "Ê≥ΩÊ∞¥Âõ∞010110=22",
  "Â§©Ê∞¥ËÆº010111=23",
  "Âú∞È£éÂçá011000=24",
  "Â±±È£éËõä011001=25",
  "Ê∞¥È£é‰∫ï011010=26",
  "Â∑Ω‰∏∫È£é011011=27",
  "Èõ∑È£éÊÅí011100=28",
  "ÁÅ´È£éÈºé011101=29",
  "Ê≥ΩÈ£éÂ§ßËøá011110=30",
  "Â§©È£éÂß§011111=31",
  "Âú∞Èõ∑Â§ç100000=32",
  "Â±±Èõ∑È¢ê100001=33",
  "Ê∞¥Èõ∑Â±Ø100010=34",
  "È£éÈõ∑Áõä100011=35",
  "Èúá‰∏∫Èõ∑100101=36",
  "ÁÅ´Èõ∑Âô¨Âóë100101=37",
  "Ê≥ΩÈõ∑Èöè100110=38",
  "Â§©Èõ∑Êó†Â¶Ñ100111=39",
  "Âú∞ÁÅ´ÊòéÂ§∑101000=40",
  "Â±±ÁÅ´Ë¥≤101001=41",
  "Ê∞¥ÁÅ´Êó¢Êµé101010=42",
  "È£éÁÅ´ÂÆ∂‰∫∫101011=43",
  "Èõ∑ÁÅ´Ë±ä101100=44",
  "Á¶ª‰∏∫ÁÅ´101101=45",
  "Ê≥ΩÁÅ´Èù©101110=46",
  "Â§©ÁÅ´Âêå‰∫∫101111=47",
  "Âú∞Ê≥Ω‰∏¥110000=48",
  "Â±±Ê≥ΩÊçü110001=49",
  "Ê∞¥Ê≥ΩËäÇ110010=50",
  "È£éÊ≥Ω‰∏≠Â≠ö110011=51",
  "Èõ∑Ê≥ΩÂΩíÂ¶π110100=52",
  "ÁÅ´Ê≥ΩÁùΩ110101=53",
  "ÂÖë‰∏∫Ê≥Ω110110=54",
  "Â§©Ê≥ΩÂ±•110111=55",
  "Âú∞Â§©Ê≥∞111000=56",
  "Â±±Â§©Â§ßÁïú111001=57",
  "Ê∞¥Â§©ÈúÄ111010=58",
  "È£éÂ§©Â∞èÁïú111011=59",
  "Èõ∑Â§©Â§ßÂ£Æ111100=60",
  "ÁÅ´Â§©Â§ßÊúâ111101=61",
  "Ê≥ΩÂ§©Â§¨111110=62",
  "‰πæ‰∏∫Â§©111111=6"
]

const GUA_HELP = "=== ÁÆóÂç¶ËØ¥Êòé === \n\n 1. ÊäõÁ°¨Â∏Å6Ê¨°ÔºåÊ≠£Èù¢ËÆ∞1ÔºåÂèçÈù¢ËÆ∞0„ÄÇ \n 2. ‰ª•„ÄêÊ±ÇÂç¶-111000„ÄëÁöÑÊñπÂºèÂèëÈÄÅËøáÊù•Âç≥ÂèØ \n 3. ÂøÉËØöÂàôÁÅµ \n 4. ÊèêÂÄ°Áî®ÊòìÊù•Êòé‰∫ãÁêÜÔºåËÄå‰∏çÊòØÊ±ÇÂëΩËøê"

const temp = "https://qwd.jd.com/cps/zl?content={content}&shareSource=1_2_2";

var subscribes = new Map()

/**
 * Ëé∑ÂèñËΩ¨ÈìæÁªìÊûú
 * 
 * @param {*} link 
 */
function inner_zl(link) {
    var result = "";
    var turl = temp.replace(new RegExp("{content}", "gm"), link);
    console.log("ÁõÆÊ†áurlÊòØ==", turl)
    var options = {
        url: turl,
        headers: {
            'Cookie': 'client_type=android;app_id=161;login_mode=2;jxjpin=jd_4aa000438e833;tgt=AAJfHT4eAEBnvigelHt_9mT8SvguScBAXBnbZIFG-vpl16MSDvsFwbTqMdreBYXMdpdPbYIKXYi0D1ARgJ5JMYVHw4mb8_ao;qwd_chn=99;qwd_schn=1',
            'User-Agent': 'jxj/3.5.22',
            'Host': 'qwd.jd.com',
            'Connection': 'Keep-Alive',
            'Accept-Encoding': 'gzip'
        }
    };
    request(options, function (err, resp, body) {
        if (err) {
            console.log("=============inner=============>Êä•Èîô‰∫Ü," , err, turl);
            result = "Êä•Èîô‰∫Ü"
            return result
        }
        console.log(resp)
        if (resp.statusCode === 200) {
            var bd = JSON.parse(body);
            if (bd.content) {
                console.log("=============inner=============>ÊàêÂäüËé∑ÂèñÂà∞ËΩ¨ÈìæÁªìÊûúÔºö" + bd.content);
                result = bd.content;
            }
            else {
                console.log(bd.msg);
                result = bd.msg;
            }
        }
    });
    return result;
}

function onScan (qrcode, status) {
  if (status === ScanStatus.Waiting || status === ScanStatus.Timeout) {
    require('qrcode-terminal').generate(qrcode, { small: true })  // show qrcode on console

    const qrcodeImageUrl = [
      'https://api.qrserver.com/v1/create-qr-code/?data=',
      encodeURIComponent(qrcode),
    ].join('')

    log.info('StarterBot', 'onScan: %s(%s) - %s', ScanStatus[status], status, qrcodeImageUrl)

  } else {
    log.info('StarterBot', 'onScan: %s(%s)', ScanStatus[status], status)
  }
}

function onLogin (user) {
  log.info('StarterBot', '%s login', user)
}

function onLogout (user) {
  log.info('StarterBot', '%s logout', user)
}

const DJT =  "https://data.zhai78.com/openOneBad.php"

const JQR = "http://api.qingyunke.com/api.php?key=free&appid=0&msg="

const XGFY = "https://cdn.mdeer.com/data/yqstaticdata.js"




async function onMessage (msg) {
  let text = msg.text()
  let fromn = msg.from().name()

  if (text.indexOf('@ËÆ¢ÈòÖ') > -1) {
    const pps = text.split('-')
    if (pps.length === 2) {
      var x = subscribes.get(fromn) || new Set()
      x.add(pps[1])
      subscribes.set(fromn , x)
      console.log(fromn + 'ÊÇ®ËÆ¢ÈòÖ‰∫ÜÔºö' + Array.from(subscribes.get(fromn)).join(','))
      await msg.say(fromn + 'ÊÇ®ËÆ¢ÈòÖ‰∫ÜÔºö' + Array.from(subscribes.get(fromn)).join(','))
      return
    }
  }
  
  // log.info('StarterBot', msg.toString())
  if (msg.self()) {
    console.log("xxxxxxxxxxxxxxxxxxxxxxxxxxxx  Ëá™Â∑±ËØ¥ÁöÑ " + msg)
    
    return
  }
  room = msg.room()

  if (text.indexOf("ÈÄÄÂá∫ÁôªÂΩï") > -1) {
    await this.logout()
    return
  }

  if (text.indexOf("Êñ∞ÂÜ†") > -1) {
    var XGFY_CONTENT=""
    axios.get("https://cdn.mdeer.com/data/yqstaticdata.js").then(function(result) {
      XGFY_CONTENT = result.data.replace("callbackstaticdata(", "")
      XGFY_CONTENT = XGFY_CONTENT.slice(0, XGFY_CONTENT.length - 1)
      let data = JSON.parse(XGFY_CONTENT)
      let country = data.country
      let source = data.dataSourceUpdateTime
      let provinceArray = data.provinceArray
      let pps = text.split("-")
      if (pps.length == 1) {
        msg.say(
          "Êà™Ëá≥" + country.time + "\n ==============\n\n" +
          "ÂÖ®ÂõΩ\n" + 
          "-> ÂÖ±Á°ÆËØä" + country.totalConfirmed +"‰æã\n"+ 
          "-> Â¢ÉÂ§ñËæìÂÖ•" + country.abroadInputConfirmed +"‰æã\n" +
          "-> ÂÖ±Ê≤ªÊÑà" + country.totalCured +"‰æã\n" + 
          "-> ÂΩìÂâçÁ°ÆËØä" + country.currentConfirm +"‰æã\n"  +
          "-> Êñ∞Â¢û" + country.totalIncrease +"‰æã\n" + 
          "-> Áñë‰ºº" + country.totalDoubtful +"‰æã\n" + 
          "-> Êñ∞Â¢ûÁñë‰ºº" + country.incDoubtful +"‰æã\n" + 
          "\n\n-------------\n „ÄêÊï∞ÊçÆÊù•Ê∫ê„Äë" + source.dataSource
        )
      }else if (pps.length == 2) {
        try {
          provinceArray.forEach((item, index) => {
            if (item.childStatistic.indexOf(pps[1]) > -1) {
              let obj = item
              throw Error(
                "Êà™Ëá≥" + country.time + "\n ==============\n\n" + 
                obj.childStatistic + "\n"+ 
                "-> ÂÖ±Á°ÆËØä" + obj.totalConfirmed +"‰æã\n"+ 
                "-> ÂÖ±Ê≤ªÊÑà" + obj.totalCured +"‰æã\n" + 
                "-> ÂΩìÂâçÁ°ÆËØä" + obj.currentConfirm +"‰æã\n"  +
                "-> Êñ∞Â¢û" + obj.totalIncrease +"‰æã\n" + 
                "-> Áñë‰ºº" + obj.totalDoubtful +"‰æã\n" + 
                "\n\n-------------\n „ÄêÊï∞ÊçÆÊù•Ê∫ê„Äë" + source.dataSource
              )
            }
          })
        } catch (error) {
          msg.say(error.message)
          return
        }
      } else if (pps.length == 3) {
        try {
          provinceArray.forEach((item, index) => {
            if (item.childStatistic.indexOf(pps[1]) > -1) {
              item.cityArray.forEach((item2, index2) => {
                if (item2.childStatistic.indexOf(pps[2]) > -1) {
                  let obj = item2
                  throw Error(
                    "Êà™Ëá≥" + country.time + "\n ==============\n\n" + 
                    obj.childStatistic + "\n"+ 
                    "-> ÂÖ±Á°ÆËØä" + obj.totalConfirmed +"‰æã\n"+ 
                    "-> ÂÖ±Ê≤ªÊÑà" + obj.totalCured +"‰æã\n" + 
                    "-> ÂΩìÂâçÁ°ÆËØä" + obj.currentConfirm +"‰æã\n"  +
                    "-> Êñ∞Â¢û" + obj.totalIncrease +"‰æã\n" + 
                    "-> Áñë‰ºº" + obj.totalDoubtful +"‰æã\n" + 
                    "\n\n-------------\n „ÄêÊï∞ÊçÆÊù•Ê∫ê„Äë" + source.dataSource
                  )
                }
              })
              
            }
          })
        } catch (error) {
          msg.say(error.message)
          return
        }
      }
    }).catch(error => {
      console.log(error)
    })
    return
  }

  if (text === "ËèúÊ†πË∞≠") {
    msg.say(CGT[randomInt(CGT.length)])
    return
  }

  if (text === "Â¢ûÂπøË¥§Êñá") {
    msg.say(ZGXW[randomInt(ZGXW.length)])
    return
  }

  if (text.indexOf("ÈíâÈíâÁæ§") > -1) {
    const img = FileBox.fromFile("g:/mmexport1594806715589.jpg")
    await msg.say(img)
    return
  }

  if (text.indexOf("ÊØí") > -1) {
    axios.get(DJT).then(function(result){
      if (result.data.txt == null) {
        msg.say("ÂéãÁÆ±Â∫ïÂÑøÁöÑÔºö" + DJT_CONTENT[randomInt(DJT_CONTENT.length)])
        return
      } else {
        msg.say(result.data.txt)
        return
      }
    }).catch(error => {
      console.log(error)
    })
    return
  }
  if(text == "Ê±ÇÂç¶") {
    await msg.say(GUA_HELP)
    return
  }
  if(text.indexOf("Ê±ÇÂç¶-") > -1) {
      let code = text.split("Ê±ÇÂç¶-")[1]
      try {
        ddict.forEach((item,index,array)=>{
          if (item.indexOf(code) > -1 ) {
            let o_name = item.split(code)[0]
            let names = o_name.split("‰∏∫")
            if (names.length > 1) {
              o_name = names[0]
            }
            if (o_name.length > 2) {
              o_name = o_name.slice(2)
            }
            throw new Error(o_name + "Âç¶")
          }
        }) 
      } catch (error) {
        log.info("ÊâæÂà∞‰∫Ü" + error.message)
        let resp = "https://baike.baidu.com/item/" + error.message
        const linkPayload = new UrlLink({ description : (" === ÂèãÊÉÖÊèêÁ§∫" + msg.from().name() + " === \nÁúãÊòìÁêÜÔºåÂëΩËøêËá™Â∑±ÊéåÊè°ÔºåÊàë‰ª¨Âè™ÈúÄË¶ÅÁúãÊ∏ÖÊó∂Â±ÄÔºÅ"), 
              thumbnailUrl: 'https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=3740483648,506813176&fm=26&gp=0.jpg', 
              title : error.message, 
              url : resp})
        
        log.info(resp)
        await msg.say(linkPayload)
        return
      }
  }

  if (room) {
    if (await msg.mentionSelf()) {
      axios.get(JQR+encodeURIComponent(text)).then(function(result){
        msg.say(result.data.content)
      })
  
      return
    } else {
      const topic = await room.topic()
      if (topic.indexOf("ÁæäÊØõ") > 0) {
        log.info(msg.from().id)
        log.info(msg.room().id)
        log.info(msg.room().owner().id)
        
        if (msg.type() == 7 && text.indexOf('jd') > -1) {
          const a = inner_zl(msg.payload.text)
          log.info('ËΩ¨Êç¢ÂêéÔºö ' + a)
          this.Contact.find({ name:'Goodbye'}).then(
            y => y.say(a)
          )
          // ÈÅçÂéÜËÆ¢ÈòÖÂàóË°®ÔºåÂ¶ÇÊûúÂ∑≤ÁªèËÆ¢ÈòÖÔºåÂàôÂèëÈÄÅÊ∂àÊÅØ
          subscribes.forEach((value, key) => {
            value.forEach(good => {
              if (a.indexOf(good) > -1) {
                this.Contact.find({name: key}).then(
                  y => y.say(a)
                )
              }
            })
          })
        } else {
          this.Contact.find({ name:'Goodbye'}).then(
            y => y.say(msg)
          )
        }        
        // this.say()
      }else{
        log.info('ÂÖ∂‰ªñÁæ§Ôºö', msg.toString())
      }
    }
  } else {
    console.log(msg)
    // axios.get(JQR+encodeURIComponent(text)).then(function(result){
    //   msg.say(result.data.content)
    // })
    
    return
  }
  
  // if (msg.type() == this.Message.Type.Text) {
  //   log.info("Ëé∑ÂèñÂà∞‰∏ÄÊù°ÊñáÊú¨ËÆ∞ÂΩï")
  // }
  
  
  // const x = this.Contact.find('ÂïäÂìàÔºåÊäΩÊäΩÔºÅ')
  // x.then(y => log.info(y.name()))
  
  // log.info('StarterBot', msg.toString())
  // if (msg.from().id == 'wxid_rw505h9zaowi22') {
  //   const room = await this.Room.find({topic: 'ÂÆ∂'})
  //   room.then(r => room.say('Â®áÁæû‰∫≤Ôºå‰Ω†ËØ¥Âï• =„Äã', msg.text()))
  // }
}

const WECHATY_PUPPET_PADCHAT_TOKEN = 'xxx'

const puppet = 'wechaty-puppet-padplus'

const puppetOptions = {
  token: WECHATY_PUPPET_PADCHAT_TOKEN,
}

const bot = new Wechaty({
  name: 'ding-dong-bot',
  /**
   * Specify a puppet for a specific protocol (Web/Pad/Mac/Windows, etc).
   *
   * You can use the following providers:
   *  - wechaty-puppet-hostie
   *  - wechaty-puppet-puppeteer
   *  - wechaty-puppet-padplus
   *  - wechaty-puppet-macpro
   *  - etc.
   *
   * Learn more about Wechaty Puppet Providers at:
   *  https://github.com/wechaty/wechaty-puppet/wiki/Directory
   */
  puppet,
  puppetOptions,
  // Set as above, or set using environment variable WECHATY_PUPPET
})

bot.on('scan',    onScan)
bot.on('login',   onLogin)
bot.on('logout',  onLogout)
bot.on('message', onMessage)

bot.start()
  .then(() => log.info('StarterBot', 'Starter Bot Started.'))
  .catch(e => log.error('StarterBot', e))

  // bot.Contact.findAll({name: "ÂïäÂìàÔºåÊäΩÊäΩÔºÅ"})
// const contact = bot.Contact.find({name: "ÂïäÂìàÔºåÊäΩÊäΩÔºÅ"}) 
// log.info('ÊâæÂà∞‰∫Ü', contact.name)
